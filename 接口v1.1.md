

通用响应格式（所有响应均以该结构封装）：
```json
{
  "code": Number,        // 状态码（200 成功）
  "message": String,     // 提示信息
  "data": Object | Array | null  // 返回数据
}
```

1. GET `/api/products` 请求（查询参数，GET 无请求体）商品列表查询，支持关键词、分类、状态、分页、排序等筛选。
```json
{
  "q": String (可选),           // 关键词
  "category_id": Number (可选),
  "status": String (可选, "online"|"frozen"|"sold"|"outOfStock"),
  "page": Number (可选, 默认 1),
  "size": Number (可选, 默认 10),
  "sort_by": String (可选, 如 "price"|"created_at"),
  "order": String (可选, "asc"|"desc")
}
```
响应 data 示例：
```json
{
  "page": Number,
  "size": Number,
  "total": Number,
  "items": [
    {
      "product_id": Number,
      "seller_id": Number,
      "category_id": Number,
      "product_name": String,
      "product_desc": String,            // 富媒体 HTML 或 Markdown
      "images": [ String ],              // 图片 URL 列表
      "price": Number,
      "stock_quantity": Number,
      "product_status": String,
      "search_keywords": String (可选),
      "created_at": String,
      "updated_at": String
    }
  ]
}
```

2. GET `/api/products/{product_id}` 查询单个商品的详细信息（含图片、媒体、分类等）。响应 data 示例：
```json
{
  "product_id": Number,
  "seller_id": Number,
  "category_id": Number,
  "product_name": String,
  "product_desc": String,
  "images": [
    { "image_id": Number, "image_url": String, "image_order": Number }
  ],
  "media_resources": [
    { "media_id": Number, "media_type": String, "media_url": String, "file_name": String }
  ],
  "price": Number,
  "stock_quantity": Number,
  "product_status": String,
  "search_keywords": String (可选),
  "category": { "category_id": Number, "parent_id": Number | null, "category_name": String },
  "created_at": String,
  "updated_at": String
}
```

3. POST `/api/products/purchase-intents` 请求体（登录客户）客户提交购买意向（下单），填写商品、数量、联系方式等。
示例请求体与响应体如下：

```json

// POST /api/purchase-intents 请求体（JSON）
{
  "product_id": Number,
  "quantity": Number,                    // 可选，默认 1
  "customer_id": Number,                 // 必填，必须与 Authorization 中的用户一致
  "customer_name": String (可选),         // 可选，若不传使用客户注册信息
  "customer_phone": String (可选),        // 可选，若不传使用客户注册信息
  "customer_address": String (可选),     // 可选，若不传使用客户默认地址
  "note": String (可选)
}

// 成功响应 data 示例（创建后记录）
{
  "purchase_id": Number,
  "product_id": Number,
  "customer_id": Number,
  "quantity": Number,
  "unit_price": Number,
  "total_amount": Number,
  "purchase_status": String,   // "pending"
  "contact_name": String,
  "contact_phone": String,
  "delivery_address": String,
  "seller_notes": String | null,
  "created_at": String,
  "updated_at": String
}

```

4. POST `/api/customers/register` 客户注册账号，填写用户名、密码、手机号、默认地址。请求体：
```json
{
  "username": String,          // 6-20 位
  "password": String,
  "phone": String,
  "default_address": String (可选)
}
```
响应 data 示例：
```json
{
  "token": String,
  "customer_info": {
    "customer_id": Number,
    "username": String,
    "phone": String,
    "default_address": String | null,
    "created_at": String,
    "updated_at": String
  }
}
```

5. POST `/api/customers/login` 客户登录，返回 token 和客户信息。请求体：
```json
{
  "username": String,
  "password": String
}
```
响应 data 示例：
```json
{
  "token": String,
  "customer_info": {
    "customer_id": Number,
    "username": String,
    "phone": String,
    "default_address": String | null,
    "created_at": String,
    "updated_at": String
  }
}
```

6. GET `/api/customers/{customer_id}/purchase-intents` 请求（仅分页/筛选参数）查询客户自己的购买意向记录，支持分页和状态筛选。
```json
{
  "page": Number (可选, 默认 1),
  "size": Number (可选, 默认 10),
  "purchase_status": String (可选)
}
```
响应 data 示例：
```json
{
  "page": Number,
  "size": Number,
  "total": Number,
  "items": [
    {
      "purchase_id": Number,
      "product_id": Number,
      "quantity": Number,
      "total_amount": Number,
      "purchase_status": String,
      "seller_notes": String | null,
      "created_at": String,
      "updated_at": String
    }
  ]
}
```

7. POST `/api/seller/login` 卖家登录，返回 token 和卖家信息。请求体：
```json
{
  "username": String,
  "password": String
}
```
响应 data 示例：
```json
{
  "token": String,
  "seller_info": {
    "seller_id": Number,
    "username": String,
    "create_time": String
  }
}
```

8. POST `/api/seller/products` 请求体（multipart/form-data 或 JSON 引用已上传 URL，已补充必填项与服务器处理）发布商品

请求说明（必填与可选）：
```json
{
  "product_name": "String (必填)",                // 与 products.product_name NOT NULL
  "product_desc": "String (必填)",                // 与 products.product_desc NOT NULL（富媒体 HTML/Markdown）
  "category_id": "Number (必填)",                 // 与 products.category_id NOT NULL，必须是存在的二级分类
  "price": "Number (必填, >=0)",                  // products.price NOT NULL
  "stock_quantity": "Number (可选, 默认 0)",       // products.stock_quantity NOT NULL DEFAULT 0
  "search_keywords": "String (可选)",             // products.search_keywords 可空
  "images": [                                     
    { "temp_key": "String"},
    {"image_url": "String ", "image_order": "Number (可选, 默认 0)" }
  ] (可选),                                       // 写入 product_images 表
  "media_resources": [
    { "temp_key": "String"},
    { "media_type": "String (可选, 'image'|'video'|'audio', 默认 'image')",
      "media_url": "String (必填)",
      "file_name": "String (必填)",
      "file_size": "Number (必填)",
      "mime_type": "String (必填)",
      "display_order": "Number (可选, 默认 0)",
      "is_embedded": "Boolean (可选, 默认 false)"
    }
  ] (可选)                                        // 写入 media_resources 表
}

```
响应 data 示例：
```json
{
  "product_id": Number,
  "product_status": String,   // "online" 或 "outOfStock"
  "created_at": String,
  "updated_at": String
}
```

9. GET `/api/seller/products` 请求（查询参数）卖家查询自己发布的商品列表，支持筛选和分页。
```json
{
  "status": String (可选),
  "page": Number (可选),
  "size": Number (可选)
}
```
响应 data 与公共商品列表相同（含历史记录）。

10. PUT `/api/seller/products/{product_id}/freeze` 卖家冻结（下架）某个商品，可填写原因。请求体：
```json
{
  "reason": String (可选)
}
```
响应 data 示例：
```json
{
  "product_id": Number,
  "product_status": String,   // "frozen"
  "updated_at": String
}
```

11. PUT `/api/seller/products/{product_id}/unfreeze` 卖家解冻（重新上架）商品，可填写备注。请求体：
```json
{
  "remark": String (可选)
}
```
响应 data 示例：
```json
{
  "product_id": Number,
  "product_status": String,   // "online" 或 "outOfStock" 取决库存
  "updated_at": String
}
```

12. PUT `/api/seller/products/{product_id}/mark-sold` 卖家标记商品为已售出，更新库存和状态。请求体：
```json
{
  "sold_quantity": Number (可选, 默认为 1),
  "note": String (可选)
}
```
响应 data 示例：
```json
{
  "product_id": Number,
  "product_status": String,   // 可能为 "sold" 或 "outOfStock"
  "stock_quantity": Number,
  "updated_at": String
}
```

13. GET `/api/seller/purchase-intents` 卖家查询收到的所有购买意向，支持筛选和分页。请求参数：
```json
{
  "purchase_status": String (可选),
  "product_id": Number (可选),
  "page": Number (可选),
  "size": Number (可选)
}
```
响应 data 示例：
```json
{
  "page": Number,
  "size": Number,
  "total": Number,
  "items": [
    {
      "purchase_id": Number,
      "product_id": Number,
      "customer_id": Number | null,
      "customer_name": String,
      "customer_phone": String,
      "customer_address": String,
      "quantity": Number,
      "total_amount": Number,
      "purchase_status": String,
      "seller_notes": String | null,
      "created_at": String,
      "updated_at": String
    }
  ]
}
```

14. PUT `/api/seller/purchase-intents/{purchase_id}/status` 卖家处理购买意向，修改其状态（如成功、失败）并备注。请求体：
```json
{
  "new_status": String,   // "success" | "failed"
  "seller_notes": String (可选)
}
```
响应 data 示例（更新后的意向）：
```json
{
  "purchase_id": Number,
  "product_id": Number,
  "customer_id": Number | null,
  "quantity": Number,
  "total_amount": Number,
  "purchase_status": String,
  "seller_notes": String | null,
  "created_at": String,
  "updated_at": String
}
```

15. GET `/api/seller/customers` 卖家查询所有客户信息，支持分页，可带最近购买记录。请求参数：
```json
{
  "page": Number (可选),
  "size": Number (可选)
}
```
响应 data 示例：
```json
{
  "page": Number,
  "size": Number,
  "total": Number,
  "items": [
    {
      "customer_id": Number,
      "username": String,
      "phone": String,
      "default_address": String | null,
      "created_at": String,
      "updated_at": String,
      "recent_purchases": [
        { "purchase_id": Number, "product_id": Number, "total_amount": Number, "created_at": String }
      ] (可选)
    }
  ]
}
```

16. PUT `/api/seller/password` 卖家修改自己的登录密码。请求体：
```json
{
  "old_password": String,
  "new_password": String
}
```
响应 data：`null`（只返回 code/message）。



17. POST `/api/media/upload` （multipart/form-data）

说明：上传媒体资源（图片、视频等），并写入 `media_resources` 表以关联商品（当前服务端实现要求提供 `product_id`）。

请求（multipart/form-data 表单字段）：
- `file` — 文件二进制，必填
- `purpose` (string) \- 可选，默认 `gallery`。取值：
    - `gallery`：作为商品图片，插入到 `product_images`。
    - `embedded`：作为富媒体嵌入资源，插入到 `media_resources`。
响应整体采用统一格式（`ApiResponse`），`data` 示例：
```json
{
  "temp_key": "b3569547-a31e-4d98-8688-ef8089f29a88",
  "media_url": "http://localhost:8080/media/temp/b3569547-a31e-4d98-8688-ef8089f29a88.jpg",
  "file_size": 840749,
  "mime_type": "image/jpeg",
  "purpose": "embedded" 
}

```
### 18. 商品类别管理

说明：类别管理分为「公开查询接口（前端/用户）」和「管理端接口（卖家/有权限的用户）」。业务层可复用，路由层分别做权限控制。最大层级为 `2`；商品上架必须指定二级分类（`category_level == 2`）。

---

#### 18.A 公开：类别查询（基路径：`/api/categories`）

- 用途：供前端/用户查看类别树或扁平列表、查询单个类别详情。公开接口仅提供读操作。

18.A.1 GET `\`/api/categories\`` — 获取类别列表（tree 或 扁平）
- 方法：GET
- 路径：`/api/categories`
- 权限：公开

查询参数（示例）：
```json
{
  "tree": "true|false (可选, 默认 true)",
  "parent_id": Number (可选),
  "level": Number (可选, 1 或 2),
  "q": String (可选),
  "page": Number (可选, 默认 1),
  "size": Number (可选, 默认 50),
  "sort_by": "created_at|category_name" (可选),
  "order": "asc|desc" (可选)
}
```

响应示例（tree=true 为树形数组；tree=false 为分页扁平结构）。

18.A.2 GET `\`/api/categories/{category_id}\`` — 查询单个类别详情
- 方法：GET
- 路径：`/api/categories/{category_id}`
- 权限：公开

---

#### 18.B 管理：商品类别管理（基路径：`/api/seller/categories`）

说明：仅卖家/有权限账户可访问写操作（需 `Authorization`）。提供增删改查、树形查询与移动/排序。若系统权限模型中卖家和管理员合并，使用该前缀即可。

18.B.1 获取分类列表（扁平）
- 方法：GET
- 路径：`/api/seller/categories`
- 权限：卖家/管理员（Authorization）

请求参数与响应同 18.A.1 中扁平列表结构（含分页）。

18.B.2 获取分类树（层级）
- 方法：GET
- 路径：`/api/seller/categories/tree`
- 权限：卖家/管理员

响应同 18.A.1 中 tree 结构。

18.B.3 查询单个分类详情
- 方法：GET
- 路径：`/api/seller/categories/{category_id}`
- 权限：卖家/管理员

响应同 18.A.2。

18.B.4 新建分类
- 方法：POST
- 路径：`/api/seller/categories`
- 权限：卖家/管理员

请求体示例：
```json
{
  "parent_id": Number | null,
  "category_name": "String"
}
```

成功响应示例：新建后的分类记录（含 `category_id`, `category_level`, `created_at`）。

18.B.5 更新分类
- 方法：PUT
- 路径：`/api/seller/categories/{category_id}`
- 权限：卖家/管理员

请求体同 18.B.4；成功响应含 `updated_at`。

18.B.6 删除分类
- 方法：DELETE
- 路径：`/api/seller/categories/{category_id}`
- 权限：卖家/管理员

行为：仅当分类无子分类且无商品引用时允许删除；否则返回 `400`，并在 `message` 中说明原因（例如：`删除失败：存在子分类` 或 `删除失败：存在商品引用`）。响应 `data = null`。

18.B.7 移动/重设父分类或排序（可选）
- 方法：PATCH
- 路径：`/api/seller/categories/{category_id}/move`
- 权限：卖家/管理员

请求体示例：
```json
{
  "new_parent_id": Number | null,
  "new_order": Number | null
}
```

响应：更新后的分类记录（同 18.B.5 返回结构）。

---
### 19：卖家查看顾客购买历史

- 方法：GET
- 路径：`/api/seller/customers/{customer_id}/purchase-history`
- 权限：卖家（需 `Authorization: Bearer <token>`）
  ```json
  {
  "code": 200,
  "message": "查询成功",
  "data": {
  "purchase_history": [
  {
  "purchase_id": 5,
  "product_id": 4,
  "customer_id": 2,
  "customer_name": "xy233",
  "customer_phone": "12345678910",
  "customer_address": "zhejiang",
  "quantity": 1,
  "total_amount": 299.99,
  "purchase_status": "success",
  "seller_notes": null,
  "created_at": "2025-10-30T13:42:44",
  "updated_at": "2025-11-03T00:58:23"
  }
  ],
  "customer_info": {
  "customer_id": 2,
  "username": "xy2333",
  "phone": "12345678910",
  "default_address": "zhejiang",
  "created_at": "2025-10-30T12:56:45",
  "updated_at": "2025-10-30T12:56:45"
  }
  }
  }
    ```
### 验证规则（约定）
- `category_name`：创建时必填，长度 `1\-64` 字符；同一级别下禁止重名。
- 最大层级：`2`（一级/二级）。创建或移动导致层级超过 `2` 时拒绝。
- 产品关联：商品上架必须指定二级分类（`category_level == 2`）。
- 删除限制：存在子分类或有商品引用时禁止删除，返回 `400` 并在 `message` 中说明原因。
- 权限区分：公开查询走 `\`/api/categories\``，管理写操作走 `\`/api/seller/categories\``（项目中若使用其它前缀，可相应替换）。

---


### 说明与实现建议
- 后端应在创建/更新时做事务性校验：验证父分类存在性、计算并写入 `category_level`、并发时避免同级重名。
- 删除前应检查商品引用（示例调用：`productMapper.countByCategoryId(id)`）。
- 对外公共查询保留 `GET /api/categories`（前端/公开）；管理接口使用 `/api/admin/...` 以区分权限。
错误示例统一返回（data = null）：
```json
{ "code": 400, "message": "错误原因说明，例如：库存不足", "data": null }
```

以上均为接口的请求体与响应体示例（Schema 风格）。