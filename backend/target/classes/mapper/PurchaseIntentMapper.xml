<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.onlineshop.mapper.PurchaseIntentMapper">

    <resultMap id="PurchaseIntentMap" type="com.example.onlineshop.entity.PurchaseIntent">
        <id property="purchaseId" column="purchase_id"/>
        <result property="productId" column="product_id"/>
        <result property="customerName" column="customer_name"/>
        <result property="customerPhone" column="customer_phone"/>
        <result property="customerAddress" column="customer_address"/>
        <result property="purchaseStatus" column="purchase_status"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <insert id="insert" parameterType="com.example.onlineshop.entity.PurchaseIntent" useGeneratedKeys="true" keyProperty="purchaseId">
        INSERT INTO purchase_intents(product_id, customer_name, customer_phone, customer_address, purchase_status)
        VALUES(#{productId}, #{customerName}, #{customerPhone}, #{customerAddress}, #{purchaseStatus})
    </insert>

    <select id="findByProductId" parameterType="int" resultMap="PurchaseIntentMap">
        SELECT * FROM purchase_intents WHERE product_id = #{productId}
    </select>

    <select id="findById" parameterType="int" resultMap="PurchaseIntentMap">
        SELECT * FROM purchase_intents WHERE purchase_id = #{purchaseId}
    </select>

    <update id="updateStatus">
        UPDATE purchase_intents SET purchase_status = #{status} WHERE purchase_id = #{purchaseId}
    </update>

    <select id="findAll" resultMap="PurchaseIntentMap">
        SELECT * FROM purchase_intents
    </select>

    <update id="markOtherIntentsFailed">
        UPDATE purchase_intents
        SET purchase_status = 'failed'
        WHERE product_id = #{productId}
          AND purchase_id != #{excludePurchaseId}
          AND purchase_status = 'pending'
    </update>

</mapper>
