### 一、核心环境要求
1. 操作系统：Windows 10、11 专业版/企业版/教育版（需开启Hyper - V）。
2. 核心工具：**Docker Desktop for Windows 4.0+**（含Docker Compose，无需单独安装）。
3. 硬件：CPU支持虚拟化（BIOS中开启）、内存≥4GB、磁盘≥15GB。


### 二、核心配置文件
#### 1. docker - compose.yml
```yaml
services:
  db: # MySQL 数据库服务
    image: mysql:8.0 # 使用官方 MySQL 8.0 镜像
    container_name: onlineshop-mysql # 容器名称
    environment: # 环境变量，初始化数据库
      MYSQL_ROOT_PASSWORD: 123456 # root 用户密码
      MYSQL_DATABASE: onlineshop # 初始化数据库名
      MYSQL_USER: shopuser # 新建用户
      MYSQL_PASSWORD: shoppass # 新建用户密码
    ports:
      - "3306:3306" # 映射主机 3306 端口到容器
    volumes:
      - ./mysql_data:/var/lib/mysql # 持久化数据库数据
      - ./test.sql:/docker-entrypoint-initdb.d/init.sql # 初始化 SQL 脚本

  backend: # 后端 Spring Boot 服务
    build: ./backend # 构建镜像的上下文目录
    container_name: onlineshop-backend # 容器名称
    ports:
      - "8080:8080" # 映射主机 8080 端口到容器
    depends_on:
      - db # 依赖 db 服务，先启动数据库
    environment: # Spring Boot 数据库连接配置
      SPRING_DATASOURCE_URL: jdbc:mysql://db:3306/onlineshop?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: shopuser
      SPRING_DATASOURCE_PASSWORD: shoppass

  frontend: # 前端 Vue 服务
    build: ./frontend/shop-front # 构建镜像的上下文目录
    container_name: onlineshop-frontend # 容器名称
    ports:
      - "80:80" # 映射主机 80 端口到容器
    depends_on:
      - backend # 依赖 backend 服务，先启动后端
```




#### 2. 前端Dockerfile（放在./frontend/shop-front目录）
```dockerfile
FROM node:20-alpine as builder
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build  # 构建前端静态资源，生成dist目录

FROM nginx:alpine
COPY default.conf /etc/nginx/conf.d/default.conf  # 复制Nginx配置
COPY --from=builder /app/dist /usr/share/nginx/html  # 复制构建产物到Nginx
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

**补充：前端Nginx配置文件（default.conf，与前端Dockerfile同目录）**
```nginx
server {
    listen 80;
    server_name localhost;

    root /usr/share/nginx/html;
    index index.html;

    # 处理Vue history模式路由，避免刷新404
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 静态资源缓存配置
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
    }
}
```

**构建过程及产生的文件**：
1. **构建触发**：`docker build -t onlineshop-frontend ./frontend/shop-front`（前端目录执行）触发构建。
2. **中间产物（builder阶段）**：
    - 在容器内`/app`目录下生成`node_modules`（依赖安装目录）。
    - 执行`npm run build`后，在容器内`/app/dist`目录生成前端静态资源（`index.html`、`css/`、`js/`、`img/`等打包后的文件）。
3. **最终产物**：
    - 生成`onlineshop-frontend`镜像（基于nginx:alpine，包含`dist`静态资源和`default.conf`配置）。
    - 本地需提前存在`default.conf`（与Dockerfile同目录），用于Nginx路由配置（如解决Vue history模式刷新404问题）。


#### 3. 后端Dockerfile（放在./backend目录）
```dockerfile
FROM openjdk:17-slim
VOLUME /tmp
COPY target/*.jar app.jar  # 复制打包后的jar包到容器
EXPOSE 8080
ENTRYPOINT ["java","-jar","/app.jar"]
```

**构建过程及产生的文件**：
1. **前置依赖**：需先在`./backend`目录通过Maven/Gradle打包生成jar包（Dockerfile依赖`target/*.jar`），执行命令：
   ```bash
   cd ./backend
   mvn clean package -DskipTests  # 生成jar包到target目录（如onlineshop-0.0.1-SNAPSHOT.jar）
   ```  
2. **构建触发**：`docker build -t onlineshop-backend ./backend`（后端目录执行）触发构建。
3. **中间产物**：
    - 本地`./backend/target`目录生成jar包（如`onlineshop-0.0.1-SNAPSHOT.jar`）及编译临时文件（`classes/`、`test-classes/`等）。
4. **最终产物**：
    - 生成`onlineshop-backend`镜像（基于openjdk:17-slim，包含复制的`app.jar`）。




### 三、Windows 部署核心步骤

#### 3.1 安装 Docker Desktop

1. 访问 [Docker 官网](https://www.docker.com/products/docker-desktop) 下载 Docker Desktop 安装包。
2. 双击安装，建议勾选“使用 WSL 2 而非 Hyper-V”（更轻量）。
3. 安装完成后启动 Docker，右下角 Docker 图标变绿表示运行正常。

#### 3.2 （可选）配置阿里云 Docker 国内镜像加速器

1. 注册并登录阿里云账号，访问 [阿里云容器镜像服务加速器](https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors) 获取专属加速器地址。
2. 打开 Docker Desktop，依次进入 `Settings` → `Docker Engine`，在 `registry-mirrors` 字段中添加你的加速器地址，例如：

   ```json
   {
     "registry-mirrors": [
       "https://你的专属加速器地址.mirror.aliyuncs.com"
     ]
   }
    ```
3. 保存并重启 Docker Desktop。

#### 3.3 准备项目文件

1. 确保项目根目录结构如下：

   ```
   项目根目录/
   ├─ frontend/shop-front
   ├─ backend/
   ├─ test.sql
   └─ docker-compose.yml
   ```

#### 3.4 准备镜像

- **3.4.1 加载本地离线镜像**

    1. 获取 `.tar` 格式的镜像文件（如 `onlineshop-backend.tar`、`onlineshop-frontend.tar`）。
    2. 依次执行：

       ```powershell
       docker load -i onlineshop-backend.tar
       docker load -i onlineshop-frontend.tar
       ```

    3. 确认镜像已加载：`docker images`



#### 3.5 一键部署与验证

1. 进入项目根目录（含 `test.sql` 和 `docker-compose.yml`），打开 PowerShell。
2. 检查并释放占用端口（需用端口：80、8080、3306）。
3. 启动服务：

   ```powershell
   docker compose up -d
   ```

4. 停止服务：

   ```powershell
   docker compose down
   ```

5. 验证部署：
    - 前端访问：http://localhost
      - 后端访问：http://localhost:8080
        好的，建议将“从阿里云拉取镜像”及相关内容单独作为“可选方案”小节，结构如下：


#### 3.6 （可选）从阿里云拉取镜像并部署

1. 拉取镜像（可替代本地构建）：

   ```powershell
   docker pull crpi-gqwsf60qsnot039b.cn-hangzhou.personal.cr.aliyuncs.com/xiaoyao233/onlineshop:v1.0-frontend
   docker pull crpi-gqwsf60qsnot039b.cn-hangzhou.personal.cr.aliyuncs.com/xiaoyao233/onlineshop:v1.0-backend
   docker pull crpi-gqwsf60qsnot039b.cn-hangzhou.personal.cr.aliyuncs.com/xiaoyao233/onlineshop:mysql-8.0
   ```

2. 执行远程镜像部署脚本，其他操作同本地文件部署流程。

